#!/usr/bin/env node

'use strict';

var mod_bunyan = require('bunyan');
var mod_mm = require('../');
var mod_path = require('path');

if (process.argv.length !== 3) {
    console.error('mmreq: must be given a single URL to fetch');
    process.exit(2);
}

var log = mod_bunyan.createLogger({
    name: 'mm',
    src: true,
    streams: [ {
        path: mod_path.join(__dirname, 'mm-debug.log'),
        level: 'trace'
    } ]
});

var account = require(mod_path.join(process.cwd(), 'account.json'));

var c = new mod_mm.Client({
    log: log,
    url: 'https://chat.joyent.us',
    account: account
});

c.on('connected', function (_) {
    c.client.get(c._pathObj(process.argv[2]),
        function (err, req, res, obj) {
        if (err) {
            console.error('mmreq: failed to fetch URL');
            console.error(err);
            process.exit(1);
        } else {
            console.log(JSON.stringify(obj, null, 4));
            process.exit(0);
        }
    });
});
